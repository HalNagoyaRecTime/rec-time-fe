# 01-fe-環境変数設定手順書

## 概要
フロントエンド（React Router v7 + Vite）における環境変数の設定と管理方法について説明します。

## 実装済み環境変数一覧

### 必須環境変数
| 変数名 | デフォルト値 | 説明 | バリデーション |
|--------|------------|------|----------------|
| `VITE_API_BASE_URL` | `https://rec-time-be.ellan122316.workers.dev/` | バックエンドAPIのURL | http/https形式チェック |
| `VITE_DEV_PORT` | `5173` | 開発サーバーのポート | 1-65535の範囲チェック |

### アプリ情報環境変数
| 変数名 | デフォルト値 | 説明 |
|--------|------------|------|
| `VITE_APP_VERSION` | `2025-09-12-01` | アプリケーションバージョン |
| `VITE_APP_NAME` | `RecTime PWA` | アプリケーション名 |

### オプション環境変数
| 変数名 | デフォルト値 | 説明 | 使用場面 |
|--------|------------|------|---------|
| `HTTPS_KEY_PATH` | `./localhost+1-key.pem` | HTTPS秘密鍵のパス | PWA開発・実機テスト時 |
| `HTTPS_CERT_PATH` | `./localhost+1.pem` | HTTPS証明書のパス | PWA開発・実機テスト時 |

## ファイル構成

### `.env.development` (開発環境用)
**⚠️ 중요**: 백엔드가 개발/본환경 DB로 분리되었으므로, 개발 환경에서는 **개발용 백엔드**를 사용해야 합니다.

```bash
# API設定
# 로컬 백엔드 사용 시 (wrangler dev 실행 중)
VITE_API_BASE_URL=http://localhost:8787

# 또는 개발용 백엔드가 배포되어 있다면 아래 주석을 해제하고 위를 주석 처리
# VITE_API_BASE_URL=https://rec-time-be-dev.your-domain.workers.dev

# 개발 서버 설정
VITE_DEV_PORT=5173
VITE_HOST=0.0.0.0
```

### `.env.production` (本番環境用)
**⚠️ 일반적으로 사용하지 않음**: 본환경은 Cloudflare Pages의 환경 변수로 설정합니다.
만약 로컬에서 프로덕션 빌드를 테스트해야 한다면 사용합니다.

```bash
# API設定（本番環境）
VITE_API_BASE_URL=https://rec-time-be.your-domain.workers.dev
```

### `.env.example` (設定例)
参考にする設定例ファイル

## Gitコミット指針

### ✅ コミット対象ファイル
- `.env.example` - 設定例として**必ずコミット**

### ❌ コミット対象外ファイル
- `.env.development` - 個人の開発環境設定（.gitignoreで除外済み）
- `.env.dev` - 個人の開発環境設定（.gitignoreで除外済み）
- `.env.local` - ローカル専用設定
- `.env.staging` - ステージング環境の機密情報を含む場合
- `.env.production` - 本番環境の機密情報を含む場合（通常はCloudflare Pagesで設定）

**理由:** 個人の開発環境設定や機密情報の漏洩を防ぐため

## 環境別設定

### 開発環境
- ファイル: `.env.development` (Vite의 기본 동작)
- 使用場面: `npm run dev` 実行時
- 特徴: 
  - **개발용 백엔드 DB**에 연결 (`http://localhost:8787` 또는 개발용 백엔드 URL)
  - 로컬 개발 중에만 사용
- 設定例:
  ```bash
  VITE_API_BASE_URL=http://localhost:8787
  ```

### ステージング環境
- ファイル: `.env.staging`
- ビルドコマンド: `npm run build:staging`
- 例: `VITE_API_BASE_URL=https://stg.example.com`

### 本番環境
- **Cloudflare Pages**の管理画面で環境変数を設定
  - Settings → Environment Variables → Production
  - `VITE_API_BASE_URL=https://rec-time-be.your-domain.workers.dev`
- `.env.production`ファイルは使用しない（セキュリティ上の理由）
- 코드의 기본값(fallback)은 본환경 URL로 설정되어 있음

## バリデーション機能

### 実装箇所
`vite.config.ts` 内で環境変数のバリデーションを実装

### バリデーション内容
1. **API URL形式チェック**
   - `http://` または `https://` で始まるかチェック
   - 無効な場合はビルドエラーで停止

2. **ポート番号チェック**
   - 1-65535の範囲内かチェック
   - 文字列の場合はNaNエラー

### エラー例
```
Error: Invalid VITE_API_BASE_URL format: "invalid-url-format". Must start with http:// or https://
Error: Invalid VITE_DEV_PORT port: 99999. Must be between 1-65535
```

## 使用方法

### 1. 初回セットアップ
```bash
# 開発環境設定ファイル 생성
# .env.development 파일을 수동으로 생성하거나 아래 명령어로 복사
cp .env.example .env.development

# 必要に応じて 값을 편집
# 개발 환경에서는 개발용 백엔드 URL을 사용
nano .env.development
```

**백엔드 DB 분리 설정**:
- 개발 환경: `VITE_API_BASE_URL=http://localhost:8787` (로컬 백엔드) 또는 개발용 백엔드 URL
- 본환경: Cloudflare Pages의 환경 변수에서 설정 (코드에 기본값 포함)

### 2. 開発サーバー起動
```bash
npm run dev
# 環境変数が自動的に読み込まれる
```

### 3. バリデーションテスト
```bash
# テスト用の無効な値でテスト
npm run dev -- --mode test
# エラーが正しく表示されることを確認
```

## トラブルシューティング

### Q: 環境変数が読み込まれない
A: 파일名이 `.env.development` (개발 환경) 또는 `.env.production` (본환경)인지 확인하세요. Vite는 자동으로 로드합니다.

### Q: 개발/본환경 DB 분리 설정 방법은?
A: 
- **개발 환경**: `.env.development`에서 `VITE_API_BASE_URL=http://localhost:8787` 설정
- **본환경**: Cloudflare Pages의 환경 변수에서 `VITE_API_BASE_URL` 설정
- 코드의 기본값은 본환경 URL로 설정되어 있어 안전함

### Q: VITE_接頭辞が必要？
A: はい。Viteでは `VITE_` 接頭辞のある環境変数のみクライアントサイドで利用可能です。

### Q: 本番環境での設定方法は？
A: Cloudflareの管理画面等で同じ環境変数名を設定。`.env`ファイルは使用しません。

### Q: バリデーションエラーが出る
A: `vite.config.ts` の検証関数を確認。正しい形式で値を設定してください。

## 関連ファイル
- `vite.config.ts`: 環境変数のバリデーション実装
- `public/sw.js`: Service WorkerでのAPP_VERSION使用
- `public/manifest.webmanifest`: PWA設定でのアプリ情報使用